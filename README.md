# PMDA 添付文書 スクレイピング＆ダウンロード統合ツール

PMDA（医薬品医療機器総合機構）の添付文書一覧ページから情報を収集し、PDF ファイルを一括ダウンロードする統合ツールです。
従来分かれていた「一覧取得」と「ファイルダウンロード」を1つのアプリケーションに統合しました。

## 特徴

* **GUI操作**: 設定ファイルの編集不要。直感的なタブ操作。
* **一括処理**: 期間指定で情報を取得し、続けてPDFをダウンロード可能。
* **フィルタリング**: 「病院内機器リスト」CSVを使って、必要な機器のPDFのみをダウンロード可能。
* **中止機能**: 収集中・ダウンロード中に処理を安全に中断可能。途中まで取得したデータも保存できます。
* **設定機能**: 出力ディレクトリや待機時間などをGUIでカスタマイズ可能。設定は自動保存されます。

## 動作環境

* Python 3.7 以上
* 必要ライブラリ: `requests`, `beautifulsoup4`
* tkinter（Python標準ライブラリ）
* Windows、macOS、Linux対応

## セットアップ

```bash
pip install requests beautifulsoup4
```

## 使い方

### 起動

```bash
python pmda_tool_with_settings.py
```

アプリケーションが起動すると、以下のウィンドウが表示されます：

**ウィンドウタイトル**: 「PMDA 添付文書 統合ツール (設定機能付き)」

**3つのタブ**:
- **Step 1: 一覧取得** - PMDAから添付文書情報を収集
- **Step 2: PDFダウンロード** - 収集した情報をもとにPDFをダウンロード
- **設定** - アプリケーション全体の動作設定

※ウィンドウのサイズと位置は自動的に保存され、次回起動時に復元されます。

### Step 1: 一覧取得タブ

PMDAのウェブサイトから添付文書の一覧情報をCSVファイルとして取得します。

1. **取得モードの選択**
   - **単一日付**: 特定の1日のみのデータを取得（**デフォルト**）
   - **期間指定**: 複数日にわたるデータを取得

2. **日付の設定**
   - **単一日付モード（デフォルト）**: 1つの日付のみを指定
     - 例：2024年12月11日
   - **期間指定モード**: 開始日と終了日を指定（年・月・日）
     - 例：2024年1月1日 ～ 2024年1月31日

3. **オプション設定**
   - 「承認番号・認証番号も取得する」（**デフォルト: 有効**）
   - チェックを入れると、各製品の承認番号・認証番号も取得します
   - ※番号取得を有効にすると処理時間が長くなります
     - 各製品ごとに詳細ページにアクセスするため、待機時間が発生します（1件あたり約0.5秒）
     - この待機時間はサーバー負荷軽減のため固定されています
   - 番号情報が不要な場合はチェックを外すと高速化できます

4. **保存先の指定**
   - CSVファイルの保存先フォルダを指定
   - デフォルト: `./output`

5. **収集開始**
   - 「収集開始」ボタンをクリックして実行
   - **中止したい場合**: 「中止」ボタンをクリック
   - 中止時は、取得済みのデータを保存するか選択できます

6. **完了**
   - 収集完了後、自動的にStep 2タブに切り替わり、作成されたCSVファイルのパスが設定されます

### Step 2: PDFダウンロードタブ

Step 1で作成したCSVファイルをもとに、PDFファイルを一括ダウンロードします。

1. **CSVファイルの選択**
   - Step 1で作成したCSVファイルを指定
   - Step 1から自動遷移した場合は既に設定済み

2. **フィルタリング設定（デフォルト: 有効）**
   - 「病院内機器リストでフィルタリングする」（**デフォルト: 有効**）
   - 有効にすると、病院で使用中の機器のみダウンロード可能
   - 機器リストCSVには「承認番号」または「認証番号」の列が必要です
   - リストに含まれる番号に一致する製品のPDFのみがダウンロード対象になります
   - 全てのPDFをダウンロードする場合はチェックを外してください

3. **保存先の指定**
   - PDFファイルの保存先フォルダを指定
   - 実際のPDFは `保存先/pdf/` フォルダに保存されます
   - デフォルト: `./output/downloads/pdf/`

4. **オプション設定**
   - 「既存ファイルをスキップ」: すでにダウンロード済みのファイルは再ダウンロードしません

5. **ダウンロード実行**
   - 「ダウンロード実行」ボタンをクリックして開始
   - **中止したい場合**: 「中止」ボタンをクリック
   - 処理状況（成功・スキップ・失敗）がリアルタイムで表示されます

6. **完了**
   - 全ファイルのダウンロードが完了すると、結果のサマリーが表示されます

### 設定タブ

アプリケーション全体の動作設定を変更できます。設定は自動的に保存され、次回起動時にも反映されます。

#### 基本設定

1. **デフォルト出力ディレクトリ**
   - CSVやPDFの保存先フォルダをデフォルトで使用するパスを指定
   - 例：`./output` や `C:/PMDA_Data`

2. **ダウンロード待機時間（秒）**
   - PDFダウンロード時の待機時間（0～10秒）
   - デフォルト：0.5秒
   - サーバー負荷を考慮して適切な値を設定してください

3. **一覧取得待機時間（秒）**
   - 日付ごとのページ取得時の待機時間（0～10秒）
   - デフォルト：0.3秒
   - 複数日の一覧を取得する際の間隔です

#### 詳細設定（上級者向け）

⚠ **警告**: 以下の設定を変更すると、正常に動作しなくなる可能性があります。

1. **PMDA一覧ページURL**
   - PMDA添付文書一覧ページのベースURL
   - デフォルト：`https://www.info.pmda.go.jp/ysearch/tenpulist.jsp?DATE=`

2. **PMDA詳細ベースURL**
   - PMDA詳細ページのベースURL
   - デフォルト：`https://www.info.pmda.go.jp`

#### 設定の保存と管理

- **設定を保存**: 現在の設定を`pmda_config.json`ファイルに保存
- **デフォルトに戻す**: すべての設定を初期値に戻す

設定ファイルは実行ファイルと同じディレクトリに作成されます。

## 出力ファイル

### Step 1（一覧取得）の出力

CSVファイルが以下の形式で生成されます：

| 列名 | 説明 |
|------|------|
| 日付 | 更新日 |
| 区分 | 掲載/削除 |
| 販売名 | 製品の販売名 |
| 企業名 | 製造販売企業名 |
| 理由 | 更新理由 |
| 承認番号 | 承認番号（オプション有効時） |
| 認証番号 | 認証番号（オプション有効時） |
| 詳細URL | PMDA詳細ページのURL |
| PDF_URL | PDF直接ダウンロードURL |

ファイル名例: `pmda_list_20241211_143022.csv`

※CSVファイルはBOM付きUTF-8形式で保存されます（Excelで開きやすい形式）

### Step 2（ダウンロード）の出力

PDFファイルが以下の形式で保存されます：

- 保存先: `指定フォルダ/pdf/`
- ファイル名: `{ドキュメントID}_{販売名(10文字)}.pdf`
  - 例: `530123AB4000_A_01_02_アキュビューオアシ.pdf`
  - 販売名は最大10文字に制限されます
  - ファイル名に使用できない文字（`\`, `/`, `:`, `*`, `?`, `"`, `<`, `>`, `|`）は `_` に置換されます
  - 販売名が取得できない場合は従来通り `{ドキュメントID}.pdf` の形式になります

## 中止機能について

処理が長時間かかる場合、いつでも安全に中止できます：

### 一覧取得の中止
- 現在処理中の日付が完了した後に停止します
- 取得済みのデータを保存するか選択できます
- 部分的なデータでも後からダウンロードタブで利用可能です

### ダウンロードの中止
- 現在ダウンロード中のファイルが完了した後に停止します
- それまでにダウンロード済みのファイルはそのまま保存されます
- 処理結果（成功・スキップ・失敗の件数）が表示されます

## 使用例

### 例1: 本日の添付文書更新を確認（デフォルト設定）

1. Step 1で「単一日付」が選択済み（デフォルト）
2. 今日の日付を確認（自動設定済み）
3. 「収集開始」をクリック
4. 完了後、Step 2で病院機器リストCSVを選択（フィルタ有効がデフォルト）
5. 「ダウンロード実行」をクリック

### 例2: 直近1週間の添付文書を全て取得

1. Step 1で「期間指定」に変更
2. 期間を指定（例：2024/12/4 ～ 2024/12/11）
3. 「収集開始」をクリック
4. 完了後、Step 2でフィルタリングのチェックを外す
5. 「ダウンロード実行」をクリック（全てダウンロード）

### 例3: 病院で使用中の機器のみを更新

1. 病院内機器リストCSV（承認番号・認証番号を含む）を準備
2. Step 1で「期間指定」を選択して収集
3. Step 2で病院機器リストCSVを選択（デフォルトで有効）
4. 「ダウンロード実行」をクリック
   → 病院で使用中の機器のPDFのみがダウンロードされます

### 例4: 長期間のデータ収集を途中で中止

1. Step 1で長期間（例：1年分）を指定して収集開始
2. 時間がかかりすぎる場合は「中止」ボタンをクリック
3. 「取得済みデータを保存しますか？」で「はい」を選択
4. 部分的なデータでStep 2に進むか、後日再開可能

## 注意事項

* PMDAサーバーへの負荷を考慮し、適切な間隔（デフォルト0.3〜0.5秒）でリクエストを送信しています
  - 一覧取得の日付間隔: 0.3秒
  - PDFダウンロード間隔: 0.5秒
  - 承認番号・認証番号取得時: 0.5秒（固定）
* ネットワークタイムアウト設定:
  - 通常のHTTPリクエスト: 30秒
  - PDFダウンロード: 60秒
* **設定機能について**:
  - 「設定」タブで待機時間や出力ディレクトリをカスタマイズできます
  - 設定は`pmda_config.json`に自動保存され、次回起動時にも反映されます
  - デフォルト設定で問題ない場合は変更不要です
* **デフォルト設定について**:
  - 取得モード: **単一日付**（日次運用向け）
  - 承認番号・認証番号の取得: **有効**（処理時間が長くなります）
  - 病院内機器リストフィルタリング: **有効**（機器リストCSVの選択が必要）
  - 不要な場合はチェックを外してください
* 承認番号・認証番号の取得を有効にすると、処理時間が大幅に増加します（1件あたり約0.5秒）
* 大量のデータを一度に取得する場合は、時間に余裕を持って実行してください
* 中止機能を使えば、必要に応じて処理を分割して実行できます
* ネットワーク接続が必要です

## ライセンス

本ツールは教育・研究目的で作成されたものです。PMDAの利用規約を遵守してご使用ください。

## トラブルシューティング

### エラー: "日付が不正です"
- 日付の入力形式を確認してください（年・月・日をそれぞれ数値で入力）

### エラー: "PMDA CSVファイルが存在しません"
- Step 1で一覧取得を先に実行してください

### エラー: "病院機器リストCSVを選択してください"
- Step 2で「病院内機器リストでフィルタリングする」が有効になっている場合、機器リストCSVの選択が必要です
- フィルタリングが不要な場合はチェックを外してください

### PDFダウンロードが失敗する
- ネットワーク接続を確認してください
- PMDAサーバーが一時的に利用できない可能性があります。時間をおいて再試行してください
- 「中止」ボタンで一旦停止し、後で再開することもできます

### 処理が遅い
- 承認番号・認証番号の取得を無効にすると高速化します
- 単一日付モードで1日ずつ処理することも検討してください
- 期間を分割して複数回実行することも検討してください
- 必要に応じて「中止」機能を使い、処理を分割してください

### 途中で停止してしまった
- 一覧取得中: 部分的なデータを保存できます
- ダウンロード中: 既にダウンロード済みのファイルは保持されます
- 「既存ファイルをスキップ」を有効にして再実行すれば、続きから処理できます

## 更新履歴

### v2.3 
- **PDFファイル名に販売名を追加**: ファイル名が `{ドキュメントID}_{販売名}.pdf` の形式に変更
- 販売名は最大10文字に制限され、ファイル名として使用できない文字は自動的に置換されます
- どの製品のPDFファイルかが一目で分かるようになりました

### v2.2 
- **設定タブを追加**: 定数をGUIで変更可能に
- 設定の保存・読み込み機能（pmda_config.json）
- デフォルト出力ディレクトリ、待機時間をカスタマイズ可能
- 詳細設定でPMDA URLも変更可能（上級者向け）

### v2.1 
- Step1に単一日付モードと期間指定モードの選択機能を追加
- **単一日付モードをデフォルトに設定**（日次運用に最適化）
- 承認番号・認証番号取得のデフォルトを「有効」に変更
- 病院内機器リストフィルタリングのデフォルトを「有効」に変更
- より実用的なデフォルト設定で使いやすさを向上

### v2.0 
- 一覧取得タブに中止機能を追加
- ダウンロードタブの中止機能を改善
- UI/UXの向上（ボタン名称の統一、メッセージの明確化）

### v1.0
- 初版リリース
- 一覧取得とダウンロードを統合
- GUIインターフェース実装
